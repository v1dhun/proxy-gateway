name: Go Build and Release

on:
  push:
    branches: [ master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ master ]

jobs:
  build-linux-windows:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version-file: 'go.mod'

    - name: 'Run Go Checks (fmt, lint, vuln, test)'
      run: |
        # Run formatting check first
        if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
          echo "Go code is not formatted:"
          gofmt -s -d .
          exit 1
        fi
        
        # Install and run other checks
        go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
        go install golang.org/x/vuln/cmd/govulncheck@latest
        golangci-lint run ./...
        govulncheck ./...
        go test ./...

    - name: Install C Cross-Compilers
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-aarch64-linux-gnu gcc-mingw-w64-x86-64

    - name: Build for Linux (amd64)
      run: CGO_ENABLED=1 GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o proxy-gateway-linux-amd64 cmd/gateway/main.go

    - name: Build for Linux (arm64)
      run: CGO_ENABLED=1 GOOS=linux GOARCH=arm64 CC=aarch64-linux-gnu-gcc go build -ldflags="-s -w" -o proxy-gateway-linux-arm64 cmd/gateway/main.go

    - name: Build for Windows (amd64)
      run: CGO_ENABLED=1 GOOS=windows GOARCH=amd64 CC=x86_64-w64-mingw32-gcc go build -ldflags="-s -w" -o proxy-gateway-windows-amd64.exe cmd/gateway/main.go

    - name: 'Upload Linux and Windows Artifacts'
      uses: actions/upload-artifact@v4
      with:
        name: proxy-gateway-builds-linux-windows
        path: |
          proxy-gateway-linux-amd64
          proxy-gateway-linux-arm64
          proxy-gateway-windows-amd64.exe

  build-macos:
    runs-on: macos-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version-file: 'go.mod'

    - name: Build for macOS (amd64)
      run: CGO_ENABLED=1 GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w" -o proxy-gateway-darwin-amd64 cmd/gateway/main.go

    - name: Build for macOS (arm64)
      run: CGO_ENABLED=1 GOOS=darwin GOARCH=arm64 go build -ldflags="-s -w" -o proxy-gateway-darwin-arm64 cmd/gateway/main.go
    
    - name: 'Upload macOS Artifacts'
      uses: actions/upload-artifact@v4
      with:
        name: proxy-gateway-builds-macos
        path: |
          proxy-gateway-darwin-amd64
          proxy-gateway-darwin-arm64

  release:
    needs: [build-linux-windows, build-macos] # Depend on both build jobs
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get tag
        id: tag
        run: echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts # Download all artifacts into this directory

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          release_name: Release ${{ steps.tag.outputs.tag }}
          draft: false
          prerelease: false

      - name: Upload All Release Assets
        run: |
          assets_dir="release-artifacts"
          for artifact_dir in "$assets_dir"/*; do
            if [ -d "$artifact_dir" ]; then
              for asset_path in "$artifact_dir"/*; do
                asset_name=$(basename "$asset_path")
                gh release upload "${{ steps.tag.outputs.tag }}" "$asset_path" --clobber
              done
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}